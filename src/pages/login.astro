---
import Form from '../components/Form.astro';
import Input from '../components/Input.astro';
import Layout from '../layouts/Layout.astro';
---

<Layout title="Indigitall Web Push - Login">
  <Form id="formLogin" submitId="submit" title="Login" labelSubmit="Submit">
    <Input id="email" type="text" label="Email" />
    <Input id="password" type="password" label="Password" />
  </Form>
</Layout>

<script>
  const formLogin = document.getElementById('formLogin') as HTMLFormElement;

  formLogin.addEventListener('submit', event => {
    event.preventDefault();

    const formData = new FormData(formLogin);
    const email = formData.get('email');
    const password = formData.get('password');

    !!email && !!password && handleLogin(email, password);
  });

  const handleLogin = async (email, password) => {
    const { login } = await import('../api/indigitall');
    const { signIn } = await import('auth-astro/client');

    const response = await signIn('credentials', {
      email,
      password,
      redirect: false,
    });

    if (response) {
      return;
    }

    login(email).then(() => {
      window.location.href = '/user-profile';
    });
  };
</script>
